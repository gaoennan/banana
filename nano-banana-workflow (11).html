<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Nano Banana å›¾ç”Ÿå›¾å·¥ä½œæµ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç§»åŠ¨ç«¯ä¼˜åŒ–æ ·å¼ */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        body {
            overscroll-behavior: none;
        }
        input, textarea, select, button {
            font-size: 16px !important; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        function App() {
            const [apiKey, setApiKey] = useState('sk-6e92f2331cc84d4b81688f494260407c');
            const [initialImage, setInitialImage] = useState(null);
            const [maxRetries, setMaxRetries] = useState(10);
            const [nodes, setNodes] = useState([
                { 
                    id: 1, 
                    prompt: '', 
                    model: 'nano-banana-pro',
                    imageSize: '1K',
                    aspectRatio: 'auto',
                    status: 'pending', 
                    result: null, 
                    progress: 0, 
                    error: '',
                    retryCount: 0
                }
            ]);
            const [isRunning, setIsRunning] = useState(false);
            const [previewImage, setPreviewImage] = useState(null);
            const [showDebugLog, setShowDebugLog] = useState(false);
            const [debugLogs, setDebugLogs] = useState([]);
            const fileInputRef = useRef(null);

            // æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼ˆä¸é‡å†™console.logï¼Œé¿å…æ— é™å¾ªç¯ï¼‰
            const addLog = (message) => {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}`;
                console.log(logEntry); // ä¿æŒåŸç”Ÿconsole.log
                setDebugLogs(prev => [...prev, logEntry].slice(-100)); // ä¿ç•™æœ€è¿‘100æ¡
            };

            // æ¨¡å‹é€‰é¡¹
            const modelOptions = [
                { value: 'nano-banana-fast', label: 'Fast (å¿«é€Ÿ)', sizes: ['1K'] },
                { value: 'nano-banana', label: 'Standard (æ ‡å‡†)', sizes: ['1K'] },
                { value: 'nano-banana-pro', label: 'Pro (ä¸“ä¸š)', sizes: ['1K', '2K', '4K'] },
                { value: 'nano-banana-pro-vt', label: 'Pro VT', sizes: ['1K', '2K', '4K'] },
                { value: 'nano-banana-pro-cl', label: 'Pro CL', sizes: ['1K', '2K', '4K'] },
                { value: 'nano-banana-pro-vip', label: 'Pro VIP', sizes: ['1K', '2K'] },
                { value: 'nano-banana-pro-4k-vip', label: 'Pro 4K VIP', sizes: ['4K'] }
            ];

            // è·å–å½“å‰æ¨¡å‹æ”¯æŒçš„åˆ†è¾¨ç‡
            const getAvailableSizes = (model) => {
                const modelConfig = modelOptions.find(m => m.value === model);
                return modelConfig ? modelConfig.sizes : ['1K'];
            };

            // è‡ªåŠ¨ä¸‹è½½å›¾ç‰‡
            const downloadImage = async (url, filename) => {
                addLog(`[ä¸‹è½½] å¼€å§‹ä¸‹è½½: ${filename}`);
                
                try {
                    // å°è¯•ç›´æ¥ä¸‹è½½
                    try {
                        const response = await fetch(url);
                        const blob = await response.blob();
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(downloadUrl);
                        addLog(`[ä¸‹è½½] âœ… ä¸‹è½½æˆåŠŸ`);
                        return;
                    } catch (fetchError) {
                        addLog(`[ä¸‹è½½] Fetchå¤±è´¥ï¼Œå°è¯•Canvasæ–¹å¼...`);
                    }

                    // Canvasæ–¹å¼ä¸‹è½½ï¼ˆå¤„ç†CORSé—®é¢˜ï¼‰
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    await new Promise((resolve, reject) => {
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            canvas.toBlob((blob) => {
                                const downloadUrl = window.URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = downloadUrl;
                                link.download = filename;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                window.URL.revokeObjectURL(downloadUrl);
                                addLog(`[ä¸‹è½½] âœ… Canvasæ–¹å¼ä¸‹è½½æˆåŠŸ`);
                                resolve();
                            }, 'image/jpeg', 0.95);
                        };
                        
                        img.onerror = (err) => {
                            addLog(`[ä¸‹è½½] âŒ ä¸‹è½½å¤±è´¥`);
                            reject(err);
                        };
                        img.src = url;
                    });
                } catch (error) {
                    addLog(`[ä¸‹è½½] âŒ ä¸‹è½½å¤±è´¥: ${error.message}`);
                    alert(`è‡ªåŠ¨ä¸‹è½½å¤±è´¥ï¼Œè¯·å³é”®ç‚¹å‡»å›¾ç‰‡æ‰‹åŠ¨ä¿å­˜`);
                }
            };

            // å°†å›¾ç‰‡è½¬æ¢ä¸º720påˆ†è¾¨ç‡
            const resizeImageTo720p = async (imageSource) => {
                addLog(`[720pè½¬æ¢] å¼€å§‹è½¬æ¢...`);
                
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    
                    // å¦‚æœæ˜¯URLï¼Œè®¾ç½®crossOrigin
                    if (imageSource.startsWith('http')) {
                        img.crossOrigin = 'anonymous';
                    }
                    
                    img.onload = () => {
                        // åˆ›å»ºcanvas
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // è®¡ç®—ç›®æ ‡å°ºå¯¸ï¼ˆä¿æŒå®½é«˜æ¯”ï¼Œæœ€é•¿è¾¹ä¸º720pï¼‰
                        let targetWidth, targetHeight;
                        const maxDimension = 1280; // 720p çš„å®½åº¦
                        
                        if (img.width > img.height) {
                            // æ¨ªå‘å›¾ç‰‡
                            targetWidth = Math.min(maxDimension, img.width);
                            targetHeight = (img.height / img.width) * targetWidth;
                        } else {
                            // çºµå‘å›¾ç‰‡
                            targetHeight = Math.min(maxDimension, img.height);
                            targetWidth = (img.width / img.height) * targetHeight;
                        }
                        
                        addLog(`[720pè½¬æ¢] ${img.width}x${img.height} â†’ ${Math.round(targetWidth)}x${Math.round(targetHeight)}`);
                        
                        canvas.width = targetWidth;
                        canvas.height = targetHeight;
                        
                        // ç»˜åˆ¶è°ƒæ•´åçš„å›¾ç‰‡
                        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                        
                        // è½¬æ¢ä¸ºbase64
                        const resizedBase64 = canvas.toDataURL('image/jpeg', 0.9);
                        addLog(`[720pè½¬æ¢] âœ… è½¬æ¢å®Œæˆ`);
                        resolve(resizedBase64);
                    };
                    
                    img.onerror = (err) => {
                        addLog(`[720pè½¬æ¢] âŒ å›¾ç‰‡åŠ è½½å¤±è´¥`);
                        reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                    };
                    
                    img.src = imageSource;
                });
            };

            // å›¾ç‰‡æ¯”ä¾‹é€‰é¡¹
            const aspectRatioOptions = [
                { value: 'auto', label: 'è‡ªåŠ¨' },
                { value: '1:1', label: '1:1 (æ­£æ–¹å½¢)' },
                { value: '16:9', label: '16:9 (å®½å±)' },
                { value: '9:16', label: '9:16 (ç«–å±)' },
                { value: '4:3', label: '4:3' },
                { value: '3:4', label: '3:4' },
                { value: '3:2', label: '3:2' },
                { value: '2:3', label: '2:3' },
                { value: '5:4', label: '5:4' },
                { value: '4:5', label: '4:5' },
                { value: '21:9', label: '21:9 (è¶…å®½)' }
            ];

            // æ·»åŠ èŠ‚ç‚¹
            const addNode = () => {
                const newNode = {
                    id: Date.now(),
                    prompt: '',
                    model: 'nano-banana-pro',
                    imageSize: '1K',
                    aspectRatio: 'auto',
                    status: 'pending',
                    result: null,
                    progress: 0,
                    error: '',
                    retryCount: 0
                };
                setNodes([...nodes, newNode]);
            };

            // åˆ é™¤èŠ‚ç‚¹
            const removeNode = (id) => {
                if (nodes.length > 1) {
                    setNodes(nodes.filter(node => node.id !== id));
                }
            };

            // æ›´æ–°èŠ‚ç‚¹ prompt
            const updateNodePrompt = (id, prompt) => {
                setNodes(nodes.map(node =>
                    node.id === id ? { ...node, prompt } : node
                ));
            };

            // æ›´æ–°èŠ‚ç‚¹æ¨¡å‹
            const updateNodeModel = (id, model) => {
                setNodes(nodes.map(node => {
                    if (node.id === id) {
                        const availableSizes = getAvailableSizes(model);
                        // å¦‚æœå½“å‰åˆ†è¾¨ç‡ä¸æ”¯æŒï¼Œé‡ç½®ä¸ºç¬¬ä¸€ä¸ªå¯ç”¨åˆ†è¾¨ç‡
                        const newImageSize = availableSizes.includes(node.imageSize) 
                            ? node.imageSize 
                            : availableSizes[0];
                        return { ...node, model, imageSize: newImageSize };
                    }
                    return node;
                }));
            };

            // æ›´æ–°èŠ‚ç‚¹åˆ†è¾¨ç‡
            const updateNodeImageSize = (id, imageSize) => {
                setNodes(nodes.map(node =>
                    node.id === id ? { ...node, imageSize } : node
                ));
            };

            // æ›´æ–°èŠ‚ç‚¹å›¾ç‰‡æ¯”ä¾‹
            const updateNodeAspectRatio = (id, aspectRatio) => {
                setNodes(nodes.map(node =>
                    node.id === id ? { ...node, aspectRatio } : node
                ));
            };

            // æ–‡ä»¶è½¬ Base64
            const fileToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const base64 = await fileToBase64(file);
                    setInitialImage(base64);
                }
            };

            // è°ƒç”¨ Nano Banana API
            const callNanoBanana = async (prompt, imageUrl, model, imageSize, aspectRatio) => {
                addLog(`[APIè°ƒç”¨] å¼€å§‹è¯·æ±‚...`);
                addLog(`[APIè°ƒç”¨] æ¨¡å‹: ${model}, åˆ†è¾¨ç‡: ${imageSize}, æ¯”ä¾‹: ${aspectRatio}`);
                addLog(`[APIè°ƒç”¨] æç¤ºè¯: ${prompt.substring(0, 50)}...`);
                
                const response = await fetch('https://grsaiapi.com/v1/draw/nano-banana', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        prompt: prompt,
                        urls: [imageUrl],
                        aspectRatio: aspectRatio,
                        imageSize: imageSize,
                        webHook: '-1',
                        shutProgress: false
                    })
                });

                const result = await response.json();
                
                if (result.code === 0) {
                    addLog(`[APIè°ƒç”¨] âœ… æˆåŠŸè·å–ä»»åŠ¡ID: ${result.data.id}`);
                    return result.data.id;
                } else {
                    addLog(`[APIè°ƒç”¨] âŒ å¤±è´¥: ${result.msg}`);
                    throw new Error(result.msg || 'è¯·æ±‚å¤±è´¥');
                }
            };

            // è½®è¯¢è·å–ç»“æœ
            const pollResult = async (taskId, nodeId) => {
                return new Promise((resolve, reject) => {
                    let pollCount = 0;
                    const maxPollCount = 300; // æœ€å¤šè½®è¯¢5åˆ†é’Ÿ (300æ¬¡ * 1ç§’)
                    
                    const interval = setInterval(async () => {
                        pollCount++;
                        
                        try {
                            const response = await fetch('https://grsaiapi.com/v1/draw/result', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${apiKey}`
                                },
                                body: JSON.stringify({ id: taskId })
                            });

                            const result = await response.json();
                            
                            if (result.code === 0) {
                                const data = result.data;
                                
                                // åªåœ¨è¿›åº¦å˜åŒ–æˆ–çŠ¶æ€å˜åŒ–æ—¶è¾“å‡ºæ—¥å¿—
                                const statusChanged = data.status !== 'running';
                                if (pollCount % 5 === 1 || statusChanged) { // æ¯5æ¬¡è½®è¯¢è¾“å‡ºä¸€æ¬¡ï¼Œæˆ–çŠ¶æ€å˜åŒ–æ—¶
                                    addLog(`[è½®è¯¢ ${pollCount}] çŠ¶æ€: ${data.status}, è¿›åº¦: ${data.progress || 0}%`);
                                }
                                
                                // æ›´æ–°è¿›åº¦
                                setNodes(prevNodes => prevNodes.map(node =>
                                    node.id === nodeId ? {
                                        ...node,
                                        progress: data.progress || 0,
                                        status: data.status === 'succeeded' ? 'completed' : 
                                               data.status === 'failed' ? 'failed' : 'running'
                                    } : node
                                ));

                                if (data.status === 'succeeded') {
                                    addLog(`[è½®è¯¢ ${pollCount}] âœ… ç”ŸæˆæˆåŠŸ!`);
                                    clearInterval(interval);
                                    resolve(data.results[0]);
                                } else if (data.status === 'failed') {
                                    addLog(`[è½®è¯¢ ${pollCount}] âŒ ç”Ÿæˆå¤±è´¥: ${data.failure_reason || data.error}`);
                                    clearInterval(interval);
                                    reject(new Error(data.failure_reason || data.error || 'ç”Ÿæˆå¤±è´¥'));
                                }
                            } else {
                                // codeä¸ä¸º0ï¼Œå¯èƒ½æ˜¯ä»»åŠ¡è¿˜æœªå‡†å¤‡å¥½
                                if (pollCount % 10 === 1) {
                                    addLog(`[è½®è¯¢ ${pollCount}] ç­‰å¾…ä»»åŠ¡å‡†å¤‡...`);
                                }
                            }
                            
                            // è¶…æ—¶æ£€æŸ¥
                            if (pollCount >= maxPollCount) {
                                addLog(`[è½®è¯¢ ${pollCount}] â±ï¸ è½®è¯¢è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰`);
                                clearInterval(interval);
                                reject(new Error('è½®è¯¢è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰'));
                            }
                        } catch (error) {
                            addLog(`[è½®è¯¢ ${pollCount}] ğŸ’¥ è½®è¯¢å¼‚å¸¸: ${error.message}`);
                            clearInterval(interval);
                            reject(error);
                        }
                    }, 1000); // æ¯1ç§’è½®è¯¢ä¸€æ¬¡
                });
            };

            // æ‰§è¡Œå·¥ä½œæµ
            const runWorkflow = async () => {
                if (!apiKey) {
                    alert('è¯·è¾“å…¥ API Key');
                    return;
                }
                if (!initialImage) {
                    alert('è¯·ä¸Šä¼ åˆå§‹å›¾ç‰‡');
                    return;
                }

                // æ¸…ç©ºæ—¥å¿—
                setDebugLogs([]);
                addLog('ğŸš€ ========== å¼€å§‹æ‰§è¡Œå·¥ä½œæµ ==========');
                addLog(`ğŸ“Š æ€»èŠ‚ç‚¹æ•°: ${nodes.length}`);
                addLog(`ğŸ”„ æœ€å¤§é‡è¯•æ¬¡æ•°: ${maxRetries}`);

                setIsRunning(true);

                // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€
                setNodes(nodes.map(node => ({
                    ...node,
                    status: 'pending',
                    result: null,
                    progress: 0,
                    error: '',
                    retryCount: 0
                })));

                // å°†åˆå§‹å›¾ç‰‡è½¬æ¢ä¸º720p
                let currentImage;
                try {
                    addLog(`[åˆå§‹åŒ–] è½¬æ¢åˆå§‹å›¾ç‰‡ä¸º720p...`);
                    currentImage = await resizeImageTo720p(initialImage);
                    addLog(`[åˆå§‹åŒ–] âœ… åˆå§‹å›¾ç‰‡å¤„ç†å®Œæˆ`);
                } catch (error) {
                    addLog(`[åˆå§‹åŒ–] âŒ åˆå§‹å›¾ç‰‡å¤„ç†å¤±è´¥: ${error.message}`);
                    alert('åˆå§‹å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message);
                    setIsRunning(false);
                    return;
                }

                try {
                    for (let i = 0; i < nodes.length; i++) {
                        const node = nodes[i];
                        
                        addLog(`\n[èŠ‚ç‚¹ ${i + 1}/${nodes.length}] ========== å¼€å§‹å¤„ç† ==========`);
                        
                        if (!node.prompt.trim()) {
                            addLog(`[èŠ‚ç‚¹ ${i + 1}] âŒ æç¤ºè¯ä¸ºç©ºï¼Œè·³è¿‡`);
                            setNodes(prevNodes => prevNodes.map(n =>
                                n.id === node.id ? { ...n, status: 'failed', error: 'è¯·è¾“å…¥æç¤ºè¯' } : n
                            ));
                            continue;
                        }

                        // é‡è¯•é€»è¾‘ï¼šä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„é‡è¯•æ¬¡æ•°
                        let success = false;
                        let retryCount = 0;
                        let lastError = null;

                        while (!success && retryCount <= maxRetries) {
                            try {
                                if (retryCount > 0) {
                                    addLog(`[èŠ‚ç‚¹ ${i + 1}] ğŸ”„ ç¬¬ ${retryCount} æ¬¡é‡è¯•...`);
                                }
                                
                                // æ›´æ–°çŠ¶æ€ä¸ºè¿è¡Œä¸­
                                setNodes(prevNodes => prevNodes.map(n =>
                                    n.id === node.id ? { 
                                        ...n, 
                                        status: 'running', 
                                        progress: 0,
                                        retryCount: retryCount,
                                        error: retryCount > 0 ? `é‡è¯•ä¸­ (${retryCount}/${maxRetries})` : ''
                                    } : n
                                ));

                                // è°ƒç”¨ API
                                const taskId = await callNanoBanana(node.prompt, currentImage, node.model, node.imageSize, node.aspectRatio);
                                
                                // è½®è¯¢ç»“æœ
                                const result = await pollResult(taskId, node.id);
                                addLog(`[èŠ‚ç‚¹ ${i + 1}] å¼€å§‹åå¤„ç†...`);
                                
                                // è‡ªåŠ¨ä¸‹è½½åŸå›¾
                                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                                const filename = `node-${i + 1}-${timestamp}.jpg`;
                                await downloadImage(result.url, filename);
                                
                                // æ›´æ–°èŠ‚ç‚¹ç»“æœ
                                setNodes(prevNodes => prevNodes.map(n =>
                                    n.id === node.id ? {
                                        ...n,
                                        status: 'completed',
                                        result: result,
                                        progress: 100,
                                        error: '',
                                        retryCount: retryCount
                                    } : n
                                ));

                                // å°†å›¾ç‰‡è½¬æ¢ä¸º720pï¼Œä½œä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å…¥
                                currentImage = await resizeImageTo720p(result.url);
                                
                                // æ ‡è®°æˆåŠŸï¼Œç«‹å³é€€å‡ºé‡è¯•å¾ªç¯
                                success = true;
                                addLog(`[èŠ‚ç‚¹ ${i + 1}] âœ… èŠ‚ç‚¹å¤„ç†å®Œæˆ${retryCount > 0 ? ` (é‡è¯•${retryCount}æ¬¡åæˆåŠŸ)` : ''}`);
                                break; // æ˜ç¡®é€€å‡ºå¾ªç¯

                            } catch (error) {
                                lastError = error;
                                retryCount++;
                                
                                if (retryCount > maxRetries) {
                                    // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
                                    addLog(`[èŠ‚ç‚¹ ${i + 1}] âŒ å¤±è´¥: ${error.message} (å·²é‡è¯•${maxRetries}æ¬¡)`);
                                    setNodes(prevNodes => prevNodes.map(n =>
                                        n.id === node.id ? {
                                            ...n,
                                            status: 'failed',
                                            error: `å¤±è´¥: ${error.message} (å·²é‡è¯•${maxRetries}æ¬¡)`,
                                            retryCount: maxRetries
                                        } : n
                                    ));
                                    success = false;
                                    break; // é€€å‡ºé‡è¯•å¾ªç¯
                                } else {
                                    // ç­‰å¾…2ç§’åé‡è¯•
                                    addLog(`[èŠ‚ç‚¹ ${i + 1}] âš ï¸ é”™è¯¯: ${error.message}ï¼Œ2ç§’åé‡è¯•...`);
                                    await new Promise(resolve => setTimeout(resolve, 2000));
                                }
                            }
                        }

                        // å¦‚æœå¤±è´¥ï¼Œåœæ­¢åç»­èŠ‚ç‚¹
                        if (!success) {
                            addLog(`[èŠ‚ç‚¹ ${i + 1}] ğŸ’” èŠ‚ç‚¹å¤±è´¥ï¼Œåœæ­¢å·¥ä½œæµ`);
                            break;
                        }
                    }
                } finally {
                    setIsRunning(false);
                    addLog('ğŸ ========== å·¥ä½œæµæ‰§è¡Œç»“æŸ ==========');
                }
            };

            // è·å–çŠ¶æ€é¢œè‰²
            const getStatusColor = (status) => {
                switch (status) {
                    case 'pending': return 'bg-gray-200 text-gray-700';
                    case 'running': return 'bg-blue-500 text-white';
                    case 'completed': return 'bg-green-500 text-white';
                    case 'failed': return 'bg-red-500 text-white';
                    default: return 'bg-gray-200 text-gray-700';
                }
            };

            const getStatusText = (status) => {
                switch (status) {
                    case 'pending': return 'ç­‰å¾…ä¸­';
                    case 'running': return 'ç”Ÿæˆä¸­';
                    case 'completed': return 'å·²å®Œæˆ';
                    case 'failed': return 'å¤±è´¥';
                    default: return 'æœªçŸ¥';
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-3 sm:p-6">
                    <div className="max-w-6xl mx-auto">
                        {/* æ ‡é¢˜ */}
                        <div className="text-center mb-4 sm:mb-8">
                            <div className="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4 mb-2">
                                <h1 className="text-2xl sm:text-4xl font-bold text-gray-800">ğŸŒ Nano Banana</h1>
                                <button
                                    onClick={() => setShowDebugLog(!showDebugLog)}
                                    className="px-3 py-1.5 text-xs sm:text-sm bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors touch-manipulation"
                                    title="æ˜¾ç¤º/éšè—è°ƒè¯•æ—¥å¿—"
                                >
                                    {showDebugLog ? 'ğŸ” éšè—æ—¥å¿—' : 'ğŸ” æ˜¾ç¤ºæ—¥å¿—'}
                                </button>
                            </div>
                            <p className="text-sm sm:text-base text-gray-600">é“¾å¼å›¾åƒç”Ÿæˆå·¥ä½œæµ</p>
                            <p className="text-xs sm:text-sm text-green-600 mt-1">âœ¨ è‡ªåŠ¨ä¸‹è½½ + 720på‹ç¼© + è‡ªå®šä¹‰é‡è¯• âœ¨</p>
                        </div>

                        {/* è°ƒè¯•æ—¥å¿— */}
                        {showDebugLog && (
                            <div className="bg-gray-900 text-green-400 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6 font-mono text-xs max-h-48 sm:max-h-60 overflow-y-auto">
                                <div className="flex justify-between items-center mb-2 sticky top-0 bg-gray-900 pb-1">
                                    <span className="font-bold text-white">ğŸ” è°ƒè¯•æ—¥å¿—</span>
                                    <button
                                        onClick={() => setDebugLogs([])}
                                        className="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700 touch-manipulation"
                                    >
                                        æ¸…ç©º
                                    </button>
                                </div>
                                {debugLogs.length === 0 ? (
                                    <div className="text-gray-500">ç­‰å¾…æ—¥å¿—...</div>
                                ) : (
                                    debugLogs.map((log, index) => (
                                        <div key={index} className="mb-1 break-all">{log}</div>
                                    ))
                                )}
                            </div>
                        )}

                        {/* API Key é…ç½® */}
                        <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 sm:mb-6">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                                {/* API Key */}
                                <div>
                                    <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                        API Key
                                    </label>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                        placeholder="è¯·è¾“å…¥æ‚¨çš„ API Key"
                                        className="w-full px-3 sm:px-4 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        disabled={isRunning}
                                    />
                                </div>
                                
                                {/* é‡è¯•æ¬¡æ•° */}
                                <div>
                                    <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                        å¤±è´¥é‡è¯•æ¬¡æ•°
                                    </label>
                                    <select
                                        value={maxRetries}
                                        onChange={(e) => setMaxRetries(Number(e.target.value))}
                                        className="w-full px-3 sm:px-4 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        disabled={isRunning}
                                    >
                                        <option value="0">ä¸é‡è¯•</option>
                                        <option value="1">é‡è¯• 1 æ¬¡</option>
                                        <option value="2">é‡è¯• 2 æ¬¡</option>
                                        <option value="3">é‡è¯• 3 æ¬¡</option>
                                        <option value="5">é‡è¯• 5 æ¬¡</option>
                                        <option value="10">é‡è¯• 10 æ¬¡</option>
                                        <option value="15">é‡è¯• 15 æ¬¡</option>
                                        <option value="20">é‡è¯• 20 æ¬¡</option>
                                    </select>
                                    <p className="text-xs text-gray-500 mt-1">
                                        {maxRetries === 0 
                                            ? 'å¤±è´¥åç«‹å³åœæ­¢' 
                                            : `æœ€å¤šé‡è¯• ${maxRetries} æ¬¡`
                                        }
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* åˆå§‹å›¾ç‰‡ä¸Šä¼  */}
                        <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 sm:mb-6">
                            <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                åˆå§‹å›¾ç‰‡
                            </label>
                            <p className="text-xs text-gray-500 mb-2">ä¸Šä¼ çš„å›¾ç‰‡ä¼šè‡ªåŠ¨è°ƒæ•´ä¸º720påˆ†è¾¨ç‡</p>
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept="image/*"
                                onChange={handleImageUpload}
                                className="hidden"
                                disabled={isRunning}
                            />
                            <div className="flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4">
                                <button
                                    onClick={() => fileInputRef.current?.click()}
                                    disabled={isRunning}
                                    className="w-full sm:w-auto px-4 py-3 sm:py-2 text-sm sm:text-base bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed touch-manipulation"
                                >
                                    {initialImage ? 'é‡æ–°ä¸Šä¼ ' : 'ğŸ“¸ ä¸Šä¼ å›¾ç‰‡'}
                                </button>
                                {initialImage && (
                                    <div 
                                        className="relative cursor-pointer group w-full sm:w-auto"
                                        onClick={() => setPreviewImage(initialImage)}
                                    >
                                        <img
                                            src={initialImage}
                                            alt="åˆå§‹å›¾ç‰‡"
                                            className="h-16 sm:h-20 max-w-full object-contain rounded-lg border-2 border-gray-300 transition-all group-hover:border-blue-500 mx-auto sm:mx-0"
                                        />
                                        <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-lg transition-all flex items-center justify-center">
                                            <span className="text-white opacity-0 group-hover:opacity-100 text-2xl">ğŸ”</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* èŠ‚ç‚¹åˆ—è¡¨ */}
                        <div className="space-y-3 sm:space-y-4 mb-4 sm:mb-6">
                            {nodes.map((node, index) => (
                                <div key={node.id} className="bg-white rounded-lg shadow-md p-3 sm:p-6">
                                    <div className="flex items-start gap-3 sm:gap-4">
                                        {/* èŠ‚ç‚¹ç¼–å· */}
                                        <div className="flex-shrink-0">
                                            <div className="w-8 h-8 sm:w-10 sm:h-10 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold text-sm sm:text-base">
                                                {index + 1}
                                            </div>
                                        </div>

                                        {/* èŠ‚ç‚¹å†…å®¹ */}
                                        <div className="flex-1 min-w-0">
                                            {/* æ¨¡å‹ã€åˆ†è¾¨ç‡å’Œå›¾ç‰‡æ¯”ä¾‹é€‰æ‹© */}
                                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-3 mb-3">
                                                {/* æ¨¡å‹é€‰æ‹© */}
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">
                                                        æ¨¡å‹
                                                    </label>
                                                    <select
                                                        value={node.model}
                                                        onChange={(e) => updateNodeModel(node.id, e.target.value)}
                                                        className="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs sm:text-sm"
                                                        disabled={isRunning}
                                                    >
                                                        {modelOptions.map(option => (
                                                            <option key={option.value} value={option.value}>
                                                                {option.label}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>

                                                {/* åˆ†è¾¨ç‡é€‰æ‹© */}
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">
                                                        åˆ†è¾¨ç‡
                                                    </label>
                                                    <select
                                                        value={node.imageSize}
                                                        onChange={(e) => updateNodeImageSize(node.id, e.target.value)}
                                                        className="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs sm:text-sm"
                                                        disabled={isRunning}
                                                    >
                                                        {getAvailableSizes(node.model).map(size => (
                                                            <option key={size} value={size}>
                                                                {size}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>

                                                {/* å›¾ç‰‡æ¯”ä¾‹é€‰æ‹© */}
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">
                                                        å›¾ç‰‡æ¯”ä¾‹
                                                    </label>
                                                    <select
                                                        value={node.aspectRatio}
                                                        onChange={(e) => updateNodeAspectRatio(node.id, e.target.value)}
                                                        className="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs sm:text-sm"
                                                        disabled={isRunning}
                                                    >
                                                        {aspectRatioOptions.map(option => (
                                                            <option key={option.value} value={option.value}>
                                                                {option.label}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>

                                            {/* Prompt è¾“å…¥ */}
                                            <div className="mb-3">
                                                <label className="block text-xs font-medium text-gray-700 mb-2">
                                                    æç¤ºè¯
                                                </label>
                                                <textarea
                                                    value={node.prompt}
                                                    onChange={(e) => updateNodePrompt(node.id, e.target.value)}
                                                    placeholder="è¾“å…¥å›¾åƒç”Ÿæˆæç¤ºè¯..."
                                                    rows="2"
                                                    className="w-full px-3 sm:px-4 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                                    disabled={isRunning}
                                                />
                                            </div>

                                            {/* çŠ¶æ€å’Œè¿›åº¦ */}
                                            <div className="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3 mb-3">
                                                <span className={`px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-medium ${getStatusColor(node.status)}`}>
                                                    {getStatusText(node.status)}
                                                    {node.retryCount > 0 && node.status === 'completed' && ` (é‡è¯•${node.retryCount}æ¬¡)`}
                                                </span>
                                                {node.status === 'running' && (
                                                    <div className="flex-1 w-full sm:w-auto">
                                                        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                                            <div
                                                                className="h-full bg-blue-500 transition-all duration-300"
                                                                style={{ width: `${node.progress}%` }}
                                                            />
                                                        </div>
                                                        <span className="text-xs text-gray-600 mt-1 inline-block">{node.progress}%</span>
                                                    </div>
                                                )}
                                            </div>

                                            {/* é”™è¯¯ä¿¡æ¯ */}
                                            {node.error && (
                                                <div className="mb-3 p-2 sm:p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-xs sm:text-sm break-words">
                                                    {node.error}
                                                </div>
                                            )}

                                            {/* ç»“æœå›¾ç‰‡ */}
                                            {node.result && (
                                                <div className="mb-3">
                                                    <div 
                                                        className="relative cursor-pointer group inline-block w-full"
                                                        onClick={() => setPreviewImage(node.result.url)}
                                                    >
                                                        <img
                                                            src={node.result.url}
                                                            alt={node.result.content}
                                                            className="w-full sm:max-w-md max-h-60 sm:max-h-80 object-contain rounded-lg border-2 border-gray-300 shadow-sm transition-all group-hover:border-blue-500"
                                                        />
                                                        <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-lg transition-all flex items-center justify-center">
                                                            <span className="text-white opacity-0 group-hover:opacity-100 text-3xl sm:text-4xl">ğŸ”</span>
                                                        </div>
                                                    </div>
                                                    <p className="mt-2 text-xs sm:text-sm text-gray-600 break-words">{node.result.content}</p>
                                                    <div className="mt-2 flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3">
                                                        <a
                                                            href={node.result.url}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="text-blue-500 hover:underline text-xs sm:text-sm"
                                                        >
                                                            åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
                                                        </a>
                                                        {index < nodes.length - 1 && (
                                                            <span className="text-xs text-green-600 bg-green-50 px-2 py-1 rounded">
                                                                âœ“ å·²ä¸‹è½½å¹¶è½¬ä¸º720pä¼ é€’
                                                            </span>
                                                        )}
                                                        {index === nodes.length - 1 && (
                                                            <span className="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                                                âœ“ å·²ä¸‹è½½ï¼ˆæœ€ç»ˆèŠ‚ç‚¹ï¼‰
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {/* åˆ é™¤æŒ‰é’® */}
                                        {nodes.length > 1 && (
                                            <button
                                                onClick={() => removeNode(node.id)}
                                                disabled={isRunning}
                                                className="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 text-red-500 hover:bg-red-50 rounded-full flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation"
                                                title="åˆ é™¤èŠ‚ç‚¹"
                                            >
                                                <span className="text-lg sm:text-xl">âœ•</span>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* æ“ä½œæŒ‰é’® */}
                        <div className="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center mb-6 sm:mb-8">
                            <button
                                onClick={addNode}
                                disabled={isRunning}
                                className="w-full sm:w-auto px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 touch-manipulation"
                            >
                                <span className="text-xl">+</span>
                                æ·»åŠ èŠ‚ç‚¹
                            </button>
                            <button
                                onClick={runWorkflow}
                                disabled={isRunning || !apiKey || !initialImage}
                                className="w-full sm:w-auto px-8 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 touch-manipulation"
                            >
                                {isRunning ? (
                                    <>
                                        <span className="animate-spin">âš™ï¸</span>
                                        æ‰§è¡Œä¸­...
                                    </>
                                ) : (
                                    <>
                                        <span>â–¶ï¸</span>
                                        å¼€å§‹æ‰§è¡Œå·¥ä½œæµ
                                    </>
                                )}
                            </button>
                        </div>

                        {/* è¯´æ˜ */}
                        <div className="mt-6 sm:mt-8 bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4">
                            <h3 className="font-bold text-blue-900 mb-2 text-sm sm:text-base">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                            <ul className="text-xs sm:text-sm text-blue-800 space-y-1 list-disc list-inside">
                                <li>âœ… å·²é…ç½®ä½¿ç”¨æµ·å¤–èŠ‚ç‚¹ï¼ˆgrsaiapi.comï¼‰</li>
                                <li>âœ… API Key å·²é¢„å¡«</li>
                                <li>ğŸ”„ è‡ªå®šä¹‰é‡è¯•æ¬¡æ•°ï¼šå¯é€‰æ‹©å¤±è´¥åé‡è¯•çš„æ¬¡æ•°ï¼ˆ0-20æ¬¡ï¼‰</li>
                                <li>ä¸Šä¼ åˆå§‹å›¾ç‰‡ä½œä¸ºèµ·ç‚¹</li>
                                <li>ğŸ–¼ï¸ ç‚¹å‡»ä»»æ„å›¾ç‰‡å¯ä»¥æ”¾å¤§é¢„è§ˆ</li>
                                <li>ğŸ¨ æ¯ä¸ªèŠ‚ç‚¹å¯é€‰æ‹©ä¸åŒçš„æ¨¡å‹ã€åˆ†è¾¨ç‡å’Œå›¾ç‰‡æ¯”ä¾‹</li>
                                <li>ğŸ“¥ è‡ªåŠ¨ä¸‹è½½ï¼šæ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆåä¼šè‡ªåŠ¨ä¸‹è½½åŸå›¾åˆ°æœ¬åœ°</li>
                                <li>ğŸ”§ æ™ºèƒ½å‹ç¼©ï¼šå›¾ç‰‡ä¼šè‡ªåŠ¨è½¬æ¢ä¸º720pä¼ é€’ç»™ä¸‹ä¸€èŠ‚ç‚¹</li>
                                <li>ğŸ“± æ”¯æŒiPhone/iPadç­‰ç§»åŠ¨è®¾å¤‡</li>
                            </ul>
                            <div className="mt-3 p-2 sm:p-3 bg-yellow-50 border border-yellow-200 rounded">
                                <p className="text-xs text-yellow-800">
                                    <strong>âš ï¸ æç¤ºï¼š</strong>ä¸åŒæ¨¡å‹æ”¯æŒçš„åˆ†è¾¨ç‡ä¸åŒï¼Œåˆ†è¾¨ç‡è¶Šé«˜ç”Ÿæˆè¶Šæ…¢
                                </p>
                            </div>
                            <div className="mt-2 sm:mt-3 p-2 sm:p-3 bg-green-50 border border-green-200 rounded">
                                <p className="text-xs text-green-800">
                                    <strong>ğŸ’¡ å·¥ä½œæµä¼˜åŒ–ï¼š</strong>è™½ç„¶å¯ä»¥é€‰æ‹©é«˜åˆ†è¾¨ç‡ï¼ˆ2K/4Kï¼‰ç”Ÿæˆï¼Œä½†ä¼ é€’ç»™ä¸‹ä¸€èŠ‚ç‚¹æ—¶ä¼šè‡ªåŠ¨å‹ç¼©ä¸º720pï¼ŒåŠ å¿«å¤„ç†é€Ÿåº¦å¹¶èŠ‚çœæˆæœ¬
                                </p>
                            </div>
                        </div>

                        {/* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */}
                        {previewImage && (
                            <div 
                                className="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4"
                                onClick={() => setPreviewImage(null)}
                            >
                                <div className="relative w-full h-full flex flex-col items-center justify-center">
                                    {/* å…³é—­æŒ‰é’® */}
                                    <button
                                        className="absolute top-2 sm:top-4 right-2 sm:right-4 w-10 h-10 sm:w-12 sm:h-12 text-white bg-black bg-opacity-50 rounded-full flex items-center justify-center text-2xl sm:text-3xl hover:bg-opacity-70 transition-colors z-10 touch-manipulation"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setPreviewImage(null);
                                        }}
                                    >
                                        âœ•
                                    </button>
                                    
                                    {/* å¤§å›¾ */}
                                    <img
                                        src={previewImage}
                                        alt="é¢„è§ˆ"
                                        className="max-w-full max-h-full object-contain"
                                        onClick={(e) => e.stopPropagation()}
                                    />
                                    
                                    {/* æç¤ºæ–‡å­— */}
                                    <div className="absolute bottom-2 sm:bottom-4 left-0 right-0 text-center text-white text-xs sm:text-sm bg-black bg-opacity-50 py-2">
                                        ç‚¹å‡»å›¾ç‰‡å¤–åŒºåŸŸæˆ–å³ä¸Šè§’ âœ• å…³é—­é¢„è§ˆ
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>